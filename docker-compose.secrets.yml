version: '3.8'

# Production Secrets Management Configuration
#
# This file demonstrates Docker Secrets usage for production deployments.
# Docker Secrets are more secure than environment variables as they:
# - Are encrypted at rest and in transit
# - Are never stored on disk in plain text
# - Are only accessible to services that need them
# - Can be rotated without rebuilding containers
#
# Usage (Docker Swarm):
#   docker stack deploy -c docker-compose.yml -c docker-compose.secrets.yml agentic
#
# For development/testing without Swarm:
#   Use docker-compose with bind-mounted secret files (see below)

secrets:
  # OpenAI API Key
  openai_api_key:
    external: true
    # Create with: echo "sk-..." | docker secret create openai_api_key -

  # Redis Password (optional, for secured Redis)
  redis_password:
    external: true
    # Create with: echo "secure_password" | docker secret create redis_password -

  # Qdrant API Key (optional, for secured Qdrant)
  qdrant_api_key:
    external: true
    # Create with: echo "api_key" | docker secret create qdrant_api_key -

  # Grafana Admin Password
  grafana_admin_password:
    external: true
    # Create with: echo "admin_password" | docker secret create grafana_admin_password -

  # Application Secret Key (for signing tokens, etc.)
  app_secret_key:
    external: true
    # Create with: python -c "import secrets; print(secrets.token_urlsafe(32))" | docker secret create app_secret_key -

services:
  api:
    secrets:
      - openai_api_key
      - redis_password
      - qdrant_api_key
      - app_secret_key
    environment:
      # Point to secret files instead of plain text env vars
      - OPENAI_API_KEY_FILE=/run/secrets/openai_api_key
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - QDRANT_API_KEY_FILE=/run/secrets/qdrant_api_key
      - APP_SECRET_KEY_FILE=/run/secrets/app_secret_key

  api-1:
    secrets:
      - openai_api_key
      - redis_password
      - qdrant_api_key
      - app_secret_key
    environment:
      - OPENAI_API_KEY_FILE=/run/secrets/openai_api_key
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - QDRANT_API_KEY_FILE=/run/secrets/qdrant_api_key
      - APP_SECRET_KEY_FILE=/run/secrets/app_secret_key

  api-2:
    secrets:
      - openai_api_key
      - redis_password
      - qdrant_api_key
      - app_secret_key
    environment:
      - OPENAI_API_KEY_FILE=/run/secrets/openai_api_key
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - QDRANT_API_KEY_FILE=/run/secrets/qdrant_api_key
      - APP_SECRET_KEY_FILE=/run/secrets/app_secret_key

  api-3:
    secrets:
      - openai_api_key
      - redis_password
      - qdrant_api_key
      - app_secret_key
    environment:
      - OPENAI_API_KEY_FILE=/run/secrets/openai_api_key
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
      - QDRANT_API_KEY_FILE=/run/secrets/qdrant_api_key
      - APP_SECRET_KEY_FILE=/run/secrets/app_secret_key

  redis:
    secrets:
      - redis_password
    environment:
      - REDIS_PASSWORD_FILE=/run/secrets/redis_password
    command: >
      sh -c 'redis-server --requirepass "$$(cat /run/secrets/redis_password)"'

  qdrant:
    secrets:
      - qdrant_api_key
    environment:
      - QDRANT__SERVICE__API_KEY_FILE=/run/secrets/qdrant_api_key

  grafana:
    secrets:
      - grafana_admin_password
    environment:
      - GF_SECURITY_ADMIN_PASSWORD__FILE=/run/secrets/grafana_admin_password
