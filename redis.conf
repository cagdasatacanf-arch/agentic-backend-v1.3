# Redis Production Configuration
# Optimized for persistence, performance, and reliability

# ============================================================================
# PERSISTENCE
# ============================================================================

# RDB (Snapshot) persistence
# Save the DB on disk:
#   save <seconds> <changes>
#   Will save the DB if both the given number of seconds and changes occurred

save 900 1      # After 900 sec (15 min) if at least 1 key changed
save 300 10     # After 300 sec (5 min) if at least 10 keys changed
save 60 10000   # After 60 sec if at least 10000 keys changed

# RDB filename
dbfilename dump.rdb

# Directory for RDB and AOF files
dir /data

# Compress RDB dumps
rdbcompression yes

# Checksum RDB files
rdbchecksum yes

# ============================================================================
# AOF (Append Only File) persistence
# ============================================================================

# Enable AOF for better durability
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# fsync policy:
# - always: fsync every write (slow but safest)
# - everysec: fsync every second (good compromise)
# - no: never fsync, let OS handle it (fastest but least safe)
appendfsync everysec

# Prevent fsync during rewrite to avoid latency spikes
no-appendfsync-on-rewrite no

# Auto-rewrite AOF when it grows by 100% and is at least 64mb
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF file on startup
aof-load-truncated yes

# Use AOF-RDB hybrid format for faster restarts
aof-use-rdb-preamble yes

# ============================================================================
# MEMORY MANAGEMENT
# ============================================================================

# Maximum memory (adjust based on your needs)
maxmemory 2gb

# Eviction policy when maxmemory is reached
# Options: allkeys-lru, allkeys-lfu, volatile-lru, volatile-lfu, allkeys-random, volatile-random, volatile-ttl, noeviction
maxmemory-policy allkeys-lru

# Number of samples for LRU/LFU algorithms (higher = more accurate but slower)
maxmemory-samples 5

# ============================================================================
# NETWORKING
# ============================================================================

# Accept connections on all interfaces
bind 0.0.0.0

# Port
port 6379

# TCP listen backlog
tcp-backlog 511

# Close connection after client idle for N seconds (0 = disabled)
timeout 300

# TCP keepalive
tcp-keepalive 300

# ============================================================================
# SECURITY
# ============================================================================

# Require password (set via environment variable or secrets)
# requirepass <password>

# Disable dangerous commands in production
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command CONFIG ""

# ============================================================================
# PERFORMANCE
# ============================================================================

# Number of databases
databases 16

# Lazy freeing for better performance
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes

# Disable active defragmentation (can cause latency spikes)
# Enable only if you have memory fragmentation issues
# activedefrag yes
# active-defrag-cycle-min 5
# active-defrag-cycle-max 75

# ============================================================================
# LOGGING
# ============================================================================

# Log level: debug, verbose, notice, warning
loglevel notice

# Log file (empty string = log to stdout)
logfile ""

# ============================================================================
# SLOW LOG
# ============================================================================

# Log queries slower than N microseconds
slowlog-log-slower-than 10000

# Maximum length of slow log
slowlog-max-len 128

# ============================================================================
# REPLICATION (for production clusters)
# ============================================================================

# Uncomment and configure for replica setup
# replicaof <masterip> <masterport>
# masterauth <master-password>

# Replica read-only mode
replica-read-only yes

# ============================================================================
# MONITORING
# ============================================================================

# Enable latency monitoring
latency-monitor-threshold 100
